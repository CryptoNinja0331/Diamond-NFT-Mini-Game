<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for contracts/facets/StakeNFTFacet.sol</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../../prettify.css" />
    <link rel="stylesheet" href="../../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../../index.html">all files</a> / <a href="index.html">contracts/facets/</a> StakeNFTFacet.sol
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>30/30</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">57.14% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>8/14</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>3/3</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>30/30</span>
      </div>
    </div>
  </div>
  <div class='status-line high'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2Ã—</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2Ã—</span>
<span class="cline-any cline-yes">2Ã—</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2Ã—</span>
<span class="cline-any cline-yes">2Ã—</span>
<span class="cline-any cline-yes">2Ã—</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2Ã—</span>
<span class="cline-any cline-yes">2Ã—</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2Ã—</span>
<span class="cline-any cline-yes">2Ã—</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2Ã—</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2Ã—</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2Ã—</span>
<span class="cline-any cline-yes">2Ã—</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2Ã—</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2Ã—</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2Ã—</span>
<span class="cline-any cline-yes">2Ã—</span>
<span class="cline-any cline-yes">2Ã—</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2Ã—</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2Ã—</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2Ã—</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2Ã—</span>
<span class="cline-any cline-yes">1Ã—</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2Ã—</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2Ã—</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2Ã—</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2Ã—</span>
<span class="cline-any cline-yes">2Ã—</span>
<span class="cline-any cline-yes">2Ã—</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">// SPDX-License-Identifier: MIT
pragma solidity ^0.8.1;
&nbsp;
// LibDiamond ðŸ’Ž Allows For Diamond Storage
import "../libraries/LibDiamond.sol";
&nbsp;
// LibStakeNFTStorage ðŸ’Ž Allows For Diamond Storage
import "../libraries/LibStakeStorage.sol";
&nbsp;
// Structs imported from DiamondStorage
// import "../libraries/LibStakeStorage.sol";
&nbsp;
import "../libraries/LibAppStorage.sol";
&nbsp;
// Structs imported from AppStorage
import {CharacterAttributes, BigBoss} from "../libraries/LibAppStorage.sol";
&nbsp;
// Hardhat Console Debugging Easy
import "hardhat/console.sol";
&nbsp;
import "./DynamicGameFacet.sol";
&nbsp;
&nbsp;
interface IERC721Diamond {
    function transferFrom(address from, address to, uint256 tokenId) external;
    function ownerOf(uint256 tokenId) external view returns (address);
}
&nbsp;
&nbsp;
// @title NFT Based Mini Game
/// @author Shiva Shanmuganathan
/// @notice You can use this contract for implementing a simple NFT based game to change NFT Metadata
/// @dev All function calls are currently implemented without side effects
contract StakeNFTFacet {
    AppStorage internal s;
&nbsp;
&nbsp;
    // Events to show that a Minting &amp; Attacking action has been completed 
    event AssetStaked(uint tokenId, uint stakeStartTime);
    event AssetUnstaked(uint tokenId, uint newPlayerHp, uint stakeStartTime, uint stakeEndTime);
&nbsp;
    // Data is passed in to the contract when it's first created initializing the characters.
    // We're going to actually pass these values in from from run.js.
  
    /// @notice User with NFT can stake their character [Metadata Of NFT Changes Here]
    /// @dev The Health of User's NFT is increased becuase of staking. [Metadata Of NFT Changes Here]
    /// The user's address &amp; index is used to get the NFT the user owns
    /// Health of Hero is increased due to staking  
    function stakeCharacter(uint tokenID, address contractAddress) external {
        
        LibStakeStorage.StakeStorage storage lss = LibStakeStorage.diamondStorage();
        // Get the state of the player's NFT.
        // uint256 nftTokenIdOfPlayer = s.nftHolders[msg.sender][_index];
        <span class="missing-if-branch" title="else path not taken" >E</span>require(s._owners[tokenID] == msg.sender, "Not NFT Owner");        
        LibStakeStorage.StakeInfo storage staked_asset = lss.stakingInfo[contractAddress][tokenID];
&nbsp;
        <span class="missing-if-branch" title="else path not taken" >E</span>require(staked_asset.startTime == 0, "NFT Already Staked.");
        CharacterAttributes memory player = s.nftHolderAttributes[tokenID];
        <span class="missing-if-branch" title="else path not taken" >E</span>require(player.hp &lt; player.maxHp, "Player Already Has Enough Hp");
&nbsp;
        staked_asset.startTime = block.timestamp;
        staked_asset.staker = msg.sender;
        
&nbsp;
        LibDiamond.DiamondStorage storage ds = LibDiamond.diamondStorage();
        bytes4 functionSelector = bytes4(keccak256("transferFrom(address,address,uint256)"));
        // get facet address of function 
        address facet = ds.facetAddressAndSelectorPosition[functionSelector].facetAddress; 
&nbsp;
        console.log("Address of THIS CONTRACT", address(this));
&nbsp;
        (bool success, bytes memory data) = facet.delegatecall(abi.encodeWithSignature("transferFrom(address,address,uint256)", msg.sender, address(this), tokenID));
        <span class="missing-if-branch" title="else path not taken" >E</span>require(success, "transfer failed"); 
&nbsp;
        emit AssetStaked(tokenID, staked_asset.startTime);
&nbsp;
    }
&nbsp;
    /// @notice User with NFT can stake their character [Metadata Of NFT Changes Here]
    /// @dev The Health of User's NFT is increased becuase of staking. [Metadata Of NFT Changes Here]
    /// The user's address &amp; index is used to get the NFT the user owns
    /// Health of Hero is increased due to staking  
    function unStakeCharacter(uint tokenID, address contractAddress) external {
        LibStakeStorage.StakeStorage storage lss = LibStakeStorage.diamondStorage();
        // Get the state of the player's NFT.
        // uint256 nftTokenIdOfPlayer = s.nftHolders[msg.sender][_index];
        
        LibStakeStorage.StakeInfo storage staked_asset = lss.stakingInfo[contractAddress][tokenID];
        <span class="missing-if-branch" title="else path not taken" >E</span>require(staked_asset.startTime != 0, "NFT Is Not Staked.");
        <span class="missing-if-branch" title="else path not taken" >E</span>require(staked_asset.staker == msg.sender, "Not NFT Staker");
&nbsp;
        CharacterAttributes storage player = s.nftHolderAttributes[tokenID];
&nbsp;
        uint stakedTime = block.timestamp - staked_asset.startTime;
        
        player.hp = player.hp + (stakedTime/60);
&nbsp;
        if(player.hp &gt;= player.maxHp){
            player.hp = player.maxHp;
        }
&nbsp;
        staked_asset.startTime = 0;
        
        DynamicGameFacet(address(this)).transferFrom(address(this), msg.sender, tokenID);
        // LibDiamond.DiamondStorage storage ds = LibDiamond.diamondStorage();
        // bytes4 functionSelector = bytes4(keccak256("transferFrom(address,address,uint256)"));
        
        // address facet = ds.facetAddressAndSelectorPosition[functionSelector].facetAddress; 
&nbsp;
        // console.log("Address of THIS CONTRACT", address(this));
        // console.log("USER Address ", msg.sender);
&nbsp;
&nbsp;
        // (bool approval_success, bytes memory approval_data) = facet.delegatecall(abi.encodeWithSignature("approve(address,uint256)", msg.sender, tokenID));
        // require(approval_success, "approval failed"); 
&nbsp;
        // (bool success, bytes memory data) = facet.delegatecall(abi.encodeWithSignature("transferFrom(address,address,uint256)", address(this), msg.sender, tokenID));
        
        // require(success, "transfer failed"); 
&nbsp;
        emit AssetUnstaked(tokenID, player.hp, staked_asset.startTime, block.timestamp);
&nbsp;
    }
&nbsp;
&nbsp;
    function getStartTime(uint tokenID, address contractAddress) external view returns(uint256){
        
        LibStakeStorage.StakeStorage storage lss = LibStakeStorage.diamondStorage();        
        LibStakeStorage.StakeInfo memory staked_asset = lss.stakingInfo[contractAddress][tokenID];
        return staked_asset.startTime;
        
    }
&nbsp;
&nbsp;
  
&nbsp;
}
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Mon Apr 25 2022 14:08:51 GMT+0530 (India Standard Time)
</div>
</div>
<script src="../../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../../sorter.js"></script>
</body>
</html>
